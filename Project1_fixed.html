<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Team 1: Project 1 - RCT, Matching</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Project1_fixed_files/libs/clipboard/clipboard.min.js"></script>
<script src="Project1_fixed_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Project1_fixed_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Project1_fixed_files/libs/quarto-html/popper.min.js"></script>
<script src="Project1_fixed_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Project1_fixed_files/libs/quarto-html/anchor.min.js"></script>
<link href="Project1_fixed_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Project1_fixed_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Project1_fixed_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Project1_fixed_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Project1_fixed_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-premise" id="toc-the-premise" class="nav-link active" data-scroll-target="#the-premise">1.The Premise</a></li>
  <li><a href="#summary-and-research-question" id="toc-summary-and-research-question" class="nav-link" data-scroll-target="#summary-and-research-question">2. Summary and Research Question</a></li>
  <li><a href="#the-dag" id="toc-the-dag" class="nav-link" data-scroll-target="#the-dag">2. The DAG</a></li>
  <li><a href="#the-potential-outcomes" id="toc-the-potential-outcomes" class="nav-link" data-scroll-target="#the-potential-outcomes">3. The Potential Outcomes</a>
  <ul>
  <li><a href="#ite" id="toc-ite" class="nav-link" data-scroll-target="#ite">3.1 ITE</a></li>
  <li><a href="#att" id="toc-att" class="nav-link" data-scroll-target="#att">3.2 ATT</a></li>
  <li><a href="#understanding-selection-bias" id="toc-understanding-selection-bias" class="nav-link" data-scroll-target="#understanding-selection-bias">3.3 Understanding Selection Bias</a></li>
  </ul></li>
  <li><a href="#building-the-dataset" id="toc-building-the-dataset" class="nav-link" data-scroll-target="#building-the-dataset">4. Building the Dataset</a>
  <ul>
  <li><a href="#patient-demographics-the-2-worlds-problem" id="toc-patient-demographics-the-2-worlds-problem" class="nav-link" data-scroll-target="#patient-demographics-the-2-worlds-problem">4.1 Patient Demographics &amp; the 2 worlds problem</a></li>
  <li><a href="#outcome-variable-moca-scores" id="toc-outcome-variable-moca-scores" class="nav-link" data-scroll-target="#outcome-variable-moca-scores">4.2 Outcome Variable: MoCA Scores</a></li>
  <li><a href="#esri-socioeconomic-status-index-sei-scale-0-to-100-continuous" id="toc-esri-socioeconomic-status-index-sei-scale-0-to-100-continuous" class="nav-link" data-scroll-target="#esri-socioeconomic-status-index-sei-scale-0-to-100-continuous">4.3 Esri Socioeconomic Status Index (SEI) Scale: 0 to 100 (Continuous)</a></li>
  <li><a href="#data-code" id="toc-data-code" class="nav-link" data-scroll-target="#data-code">4.4 Data Code</a></li>
  </ul></li>
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda">5. EDA</a>
  <ul>
  <li><a href="#age-distribution-between-control-and-treated-groups" id="toc-age-distribution-between-control-and-treated-groups" class="nav-link" data-scroll-target="#age-distribution-between-control-and-treated-groups">5.1 Age Distribution between control and treated groups</a></li>
  <li><a href="#cognitive-decline-between-control-and-treated-groups-as-a-function-of-age" id="toc-cognitive-decline-between-control-and-treated-groups-as-a-function-of-age" class="nav-link" data-scroll-target="#cognitive-decline-between-control-and-treated-groups-as-a-function-of-age">5.2 Cognitive Decline between control and treated groups as a function of age</a></li>
  <li><a href="#ses-by-treatment-group" id="toc-ses-by-treatment-group" class="nav-link" data-scroll-target="#ses-by-treatment-group">5.3 SES by Treatment Group</a></li>
  <li><a href="#propensity-score-overlap" id="toc-propensity-score-overlap" class="nav-link" data-scroll-target="#propensity-score-overlap">5.4 Propensity score overlap</a></li>
  </ul></li>
  <li><a href="#matching" id="toc-matching" class="nav-link" data-scroll-target="#matching">6. Matching</a>
  <ul>
  <li><a href="#k-1-exact-matching" id="toc-k-1-exact-matching" class="nav-link" data-scroll-target="#k-1-exact-matching">6.3 k-1 Exact Matching</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#coarsened-exact-matching" id="toc-coarsened-exact-matching" class="nav-link" data-scroll-target="#coarsened-exact-matching">6.2 Coarsened Exact Matching</a></li>
  <li><a href="#propensity-score-matching" id="toc-propensity-score-matching" class="nav-link" data-scroll-target="#propensity-score-matching">6.3 Propensity Score Matching</a>
  <ul>
  <li><a href="#create-matches" id="toc-create-matches" class="nav-link" data-scroll-target="#create-matches">Create Matches</a></li>
  <li><a href="#check-balance" id="toc-check-balance" class="nav-link" data-scroll-target="#check-balance">Check Balance</a></li>
  <li><a href="#treatment-effect-via-dim" id="toc-treatment-effect-via-dim" class="nav-link" data-scroll-target="#treatment-effect-via-dim">Treatment Effect via DiM</a></li>
  <li><a href="#treatment-effect-via-g-computation-ate" id="toc-treatment-effect-via-g-computation-ate" class="nav-link" data-scroll-target="#treatment-effect-via-g-computation-ate">Treatment Effect via G-Computation (ATE)</a></li>
  <li><a href="#potential-outcomes-ate" id="toc-potential-outcomes-ate" class="nav-link" data-scroll-target="#potential-outcomes-ate">Potential Outcomes (ATE)</a></li>
  </ul></li>
  <li><a href="#iptw-analysis" id="toc-iptw-analysis" class="nav-link" data-scroll-target="#iptw-analysis">6.4 IPTW Analysis</a></li>
  </ul></li>
  <li><a href="#randomized-control-trial" id="toc-randomized-control-trial" class="nav-link" data-scroll-target="#randomized-control-trial">7. Randomized Control Trial</a>
  <ul>
  <li><a href="#housekeeping" id="toc-housekeeping" class="nav-link" data-scroll-target="#housekeeping">7.0 Housekeeping</a></li>
  <li><a href="#simple-treatment-assignment" id="toc-simple-treatment-assignment" class="nav-link" data-scroll-target="#simple-treatment-assignment">7.1 Simple Treatment Assignment</a>
  <ul>
  <li><a href="#treatment-assignment" id="toc-treatment-assignment" class="nav-link" data-scroll-target="#treatment-assignment">Treatment Assignment</a>
  <ul class="collapse">
  <li><a href="#proportions" id="toc-proportions" class="nav-link" data-scroll-target="#proportions">Proportions</a></li>
  </ul></li>
  <li><a href="#check-age-balance" id="toc-check-age-balance" class="nav-link" data-scroll-target="#check-age-balance">Check Age Balance</a>
  <ul class="collapse">
  <li><a href="#mosaic-plot" id="toc-mosaic-plot" class="nav-link" data-scroll-target="#mosaic-plot">Mosaic Plot</a></li>
  <li><a href="#ks-test" id="toc-ks-test" class="nav-link" data-scroll-target="#ks-test">KS Test</a></li>
  <li><a href="#qq-plot" id="toc-qq-plot" class="nav-link" data-scroll-target="#qq-plot">QQ Plot</a></li>
  <li><a href="#equal-proportions-oldyoung" id="toc-equal-proportions-oldyoung" class="nav-link" data-scroll-target="#equal-proportions-oldyoung">Equal Proportions (Old/Young)</a></li>
  </ul></li>
  <li><a href="#check-ses-balance" id="toc-check-ses-balance" class="nav-link" data-scroll-target="#check-ses-balance">Check SES Balance</a>
  <ul class="collapse">
  <li><a href="#mosaic-plot-1" id="toc-mosaic-plot-1" class="nav-link" data-scroll-target="#mosaic-plot-1">Mosaic Plot</a></li>
  <li><a href="#ks-test-1" id="toc-ks-test-1" class="nav-link" data-scroll-target="#ks-test-1">KS Test</a></li>
  </ul></li>
  <li><a href="#estimate-te" id="toc-estimate-te" class="nav-link" data-scroll-target="#estimate-te">Estimate TE</a>
  <ul class="collapse">
  <li><a href="#difference-in-means" id="toc-difference-in-means" class="nav-link" data-scroll-target="#difference-in-means">Difference in Means</a></li>
  <li><a href="#t-test" id="toc-t-test" class="nav-link" data-scroll-target="#t-test">T-Test</a></li>
  <li><a href="#ols-regression" id="toc-ols-regression" class="nav-link" data-scroll-target="#ols-regression">OLS Regression</a></li>
  <li><a href="#ate-att-atc-via-regression" id="toc-ate-att-atc-via-regression" class="nav-link" data-scroll-target="#ate-att-atc-via-regression">ATE / ATT / ATC via Regression</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#complete-treatment-assignment" id="toc-complete-treatment-assignment" class="nav-link" data-scroll-target="#complete-treatment-assignment">7.2 Complete Treatment Assignment</a>
  <ul>
  <li><a href="#decide-of-treatcontrol" id="toc-decide-of-treatcontrol" class="nav-link" data-scroll-target="#decide-of-treatcontrol">Decide # of Treat/Control</a></li>
  <li><a href="#complete-random-assignment" id="toc-complete-random-assignment" class="nav-link" data-scroll-target="#complete-random-assignment">Complete Random Assignment</a></li>
  <li><a href="#check-age-balance-1" id="toc-check-age-balance-1" class="nav-link" data-scroll-target="#check-age-balance-1">Check Age Balance</a></li>
  <li><a href="#compute-te" id="toc-compute-te" class="nav-link" data-scroll-target="#compute-te">Compute TE</a></li>
  </ul></li>
  <li><a href="#block-treatment-assignment" id="toc-block-treatment-assignment" class="nav-link" data-scroll-target="#block-treatment-assignment">7.3 Block Treatment Assignment</a>
  <ul>
  <li><a href="#blocking-by-age" id="toc-blocking-by-age" class="nav-link" data-scroll-target="#blocking-by-age">Blocking by Age</a></li>
  <li><a href="#check-age-balance-2" id="toc-check-age-balance-2" class="nav-link" data-scroll-target="#check-age-balance-2">Check Age Balance</a></li>
  <li><a href="#check-ses-balance-1" id="toc-check-ses-balance-1" class="nav-link" data-scroll-target="#check-ses-balance-1">Check SES Balance</a></li>
  <li><a href="#compute-te-1" id="toc-compute-te-1" class="nav-link" data-scroll-target="#compute-te-1">Compute TE</a></li>
  </ul></li>
  <li><a href="#cluster-treatment-assignment" id="toc-cluster-treatment-assignment" class="nav-link" data-scroll-target="#cluster-treatment-assignment">7.4 Cluster Treatment Assignment</a>
  <ul>
  <li><a href="#form-the-clusters" id="toc-form-the-clusters" class="nav-link" data-scroll-target="#form-the-clusters">Form the Clusters</a></li>
  <li><a href="#cluster-assignment" id="toc-cluster-assignment" class="nav-link" data-scroll-target="#cluster-assignment">Cluster Assignment</a></li>
  <li><a href="#compute-te-2" id="toc-compute-te-2" class="nav-link" data-scroll-target="#compute-te-2">Compute TE</a></li>
  </ul></li>
  <li><a href="#summary-of-rct-estimates" id="toc-summary-of-rct-estimates" class="nav-link" data-scroll-target="#summary-of-rct-estimates">7.5 Summary of RCT Estimates</a></li>
  </ul></li>
  <li><a href="#selection-bias-method-comparison" id="toc-selection-bias-method-comparison" class="nav-link" data-scroll-target="#selection-bias-method-comparison">8. Selection Bias &amp; Method Comparison</a>
  <ul>
  <li><a href="#naive-difference-in-means" id="toc-naive-difference-in-means" class="nav-link" data-scroll-target="#naive-difference-in-means">8.1 Naive Difference in Means</a></li>
  <li><a href="#selection-bias-across-methods" id="toc-selection-bias-across-methods" class="nav-link" data-scroll-target="#selection-bias-across-methods">8.2 Selection Bias Across Methods</a></li>
  <li><a href="#residual-plot-estimated-effect-vs-true-effect" id="toc-residual-plot-estimated-effect-vs-true-effect" class="nav-link" data-scroll-target="#residual-plot-estimated-effect-vs-true-effect">8.3 Residual Plot: Estimated Effect vs True Effect</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Team 1: Project 1 - RCT, Matching</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Team 1 </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="the-premise" class="level2">
<h2 class="anchored" data-anchor-id="the-premise">1.The Premise</h2>
<p><strong>Team Domain:</strong> Healthcare Policy &amp; Medical Technology</p>
<p><strong>Client:</strong> <strong>The Center for Medicare &amp; Medicaid Services (CMS).</strong></p>
<ul>
<li>Why them? They pay for both the pacemakers and the long-term care for dementia/stroke. They care about systemic inefficiencies costing them money.</li>
</ul>
<p><strong>The Narrative: Unintended/Tangential Consequences in Medicine</strong></p>
<ul>
<li><p>Pacemakers are life saving for arrhythmia. However, they create a logistical barrier. Many hospitals (especially smaller or rural ones) refuse to perform MRIs on patients with pacemakers due to liability costs, insurance barriers and staffing requirements (technicians need to reprogram the device before/after the scan).</p></li>
<li><p>This means that elderly pacemaker patients with early signs of neurological issues <em>(eg. mini-strokes, normal pressure hydrocephalus, abnormal cognitive decline associated with dementia)</em> may face <strong>delayed diagnosis</strong> compared to non-pacemaker patients.</p></li>
<li><p><strong>Hypothesis:</strong> This delay leads to faster, unmanaged cognitive decline over a 3-year period.</p></li>
</ul>
</section>
<section id="summary-and-research-question" class="level2">
<h2 class="anchored" data-anchor-id="summary-and-research-question">2. Summary and Research Question</h2>
<p><strong>Research Question:</strong> Does the presence of a pacemaker cause a lower <strong>MoCA</strong> <strong>Score</strong> (3 years post-diagnosis) due to restricted access to diagnostic imaging?</p>
<p><strong>The Treatment (D)</strong>: Having a Pacemaker implanted (D=1)</p>
<p><strong>The Outcome (Y)</strong>: Montreal Cognitive Assessment (MoCA): a 30-point test, higher score is better. &lt;26 indicates cognitive impairment</p>
<p><strong>Treatment Effect:</strong> This is the <strong>Diagnostic Penalty.</strong> It’s the change in the test score caused by having the pacemaker. Because the pacemaker makes it harder to get an MRI, doctors might miss small brain issues. We expect this effect to be negative (the pacemaker causes the score to drop compared to not having one)</p>
<ul>
<li><p><strong>Confounders (X):</strong> These are the variables that affect both whether you get a pacemaker and what your cognitive score is. If we don’t control for these, our results will be biased. The Three Main Confounders:</p></li>
<li><p><strong>Age:</strong> Older people are more likely to need a pacemaker (D), but they also naturally have lower MoCA scores (Y)</p></li>
<li><p><strong>SES Index (Esri):</strong> People with a higher socioeconomic status have better access to heart surgery (D) and also better access to nutrition and education, which keeps MoCA scores high (Y)</p></li>
</ul>
</section>
<section id="the-dag" class="level2">
<h2 class="anchored" data-anchor-id="the-dag">2. The DAG</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>dag <span class="ot">&lt;-</span> <span class="fu">dagitty</span>(<span class="st">"dag {</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">  D &lt;- x1 -&gt; Y</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">  D &lt;- x2 -&gt; Y</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">  D -&gt; Y</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="st">}"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>tidy_dag <span class="ot">&lt;-</span> <span class="fu">tidy_dagitty</span>(dag) <span class="sc">%&gt;%</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"D"</span>  <span class="sc">~</span> <span class="st">"Having a Pacemaker"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"Y"</span>  <span class="sc">~</span> <span class="st">"MoCA Score"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"x1"</span> <span class="sc">~</span> <span class="st">"Age"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    name <span class="sc">==</span> <span class="st">"x2"</span> <span class="sc">~</span> <span class="st">"SES Index"</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> name</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(tidy_dag) <span class="sc">+</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> label),<span class="at">size=</span><span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><img src="DAG.jpg" class="img-fluid"></p>
</section>
<section id="the-potential-outcomes" class="level2">
<h2 class="anchored" data-anchor-id="the-potential-outcomes">3. The Potential Outcomes</h2>
<p>We are trying to think of these Parallel Universe scores for every patient in our data. Even though we only see one reality, we imagine two:</p>
<ul>
<li><p><span class="math inline">\(Y_i(1)\)</span>: The MoCA score for patient <span class="math inline">\(i\)</span> <strong>if they receive</strong> the pacemaker.</p></li>
<li><p><span class="math inline">\(Y_i(0)\)</span>: The MoCA score for patient <span class="math inline">\(i\)</span> <strong>if they do not receive</strong> the pacemaker.</p></li>
</ul>
<section id="ite" class="level3">
<h3 class="anchored" data-anchor-id="ite">3.1 ITE</h3>
<p>If Bob has a pacemaker, the ITE is the score Bob actually got minus the score Bob would have gotten if he never had the surgery.</p>
<p><span class="math inline">\(ITE =Y_i(1)\)</span> - <span class="math inline">\(Y_i(0)\)</span></p>
</section>
<section id="att" class="level3">
<h3 class="anchored" data-anchor-id="att">3.2 ATT</h3>
<blockquote class="blockquote">
<p>For the group that got the pacemaker, how much did their scores drop compared to what their scores would have been if they didn’t have the device?</p>
</blockquote>
<p><span class="math display">\[ATT=E[Yi​(1)−Yi​(0)∣Di​=1]\]</span></p>
<ul>
<li><p><span class="math inline">\(E[Y_i(1) \mid D_i = 1]\)</span> The average score we actually see for pacemaker patients.</p></li>
<li><p><span class="math inline">\(E[Y_i(0) \mid D_i = 1]\)</span> The Counterfactual: What those same pacemaker patients would have scored if they never got the device. This is the invisible part we use Matching to find.</p></li>
</ul>
</section>
<section id="understanding-selection-bias" class="level3">
<h3 class="anchored" data-anchor-id="understanding-selection-bias">3.3 Understanding Selection Bias</h3>
<p>If we just subtract the average of the No-Pacemaker group from the Pacemaker group, we get this:</p>
<p><span class="math display">\[\underbrace{E[Y_i|D_i=1]-E[Y_i|D_i=0]}_{\text{Difference in Means}}=\underbrace{ATT}_{\text{True Effect}}+\underbrace{\{E[Y_i(0)|D_i=1]-E[Y_i(0)|D_i=0]\}}_{\text{Selection Bias}}\]</span></p>
<ul>
<li>The Selection Bias part is there because the people who got the pacemaker (the treated) would have had different scores anyway compared to the healthy people who didn’t get one (the control), even if neither group had the device.</li>
</ul>
</section>
</section>
<section id="building-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="building-the-dataset">4. Building the Dataset</h2>
<section id="patient-demographics-the-2-worlds-problem" class="level3">
<h3 class="anchored" data-anchor-id="patient-demographics-the-2-worlds-problem">4.1 Patient Demographics &amp; the 2 worlds problem</h3>
<p>To realistically model Selection Bias, we created a distinct age gap between our Treated (Pacemaker) and Control (No Pacemaker) groups.</p>
<ul>
<li><p><strong>Pacemaker Group:</strong> A mean age of <strong>76 (</strong><span class="math inline">\(\pm 11\)</span>). This aligns with registry data showing the average age of first implantation is between 75 and 76 years old.</p></li>
<li><p><strong>Control Group:</strong> A mean age of <strong>58 (</strong><span class="math inline">\(\pm 20\)</span>), representing the general inpatient population.</p></li>
<li><p><strong>Reasoning:</strong> In observational data, people with pacemakers are naturally older. If we did not model this age gap, we would fail to capture the real world confounding variables that our Matching needs to solve.</p></li>
</ul>
<blockquote class="blockquote">
<p><strong>Source:</strong> <em>Greenspon, A. J., et al.&nbsp;(2011). Trends in permanent pacemaker implantation in the United States. Journal of the American College of Cardiology.</em> <a href="https://www.google.com/search?q=https://www.jacc.org/doi/full/10.1016/j.jacc.2011.03.009&amp;authuser=1">Link to Study</a></p>
</blockquote>
</section>
<section id="outcome-variable-moca-scores" class="level3">
<h3 class="anchored" data-anchor-id="outcome-variable-moca-scores">4.2 Outcome Variable: MoCA Scores</h3>
<p>We used the <strong>Montreal Cognitive Assessment (MoCA)</strong> scale (0–30 points) as our outcome.</p>
<ul>
<li><p><strong>Baseline Score:</strong> We set the baseline for a healthy 60-year-old at <strong>27.5 points</strong>, consistent with data for “Normal Cognitive Function.”</p></li>
<li><p><strong>Age Decay:</strong> We programmed a natural decline of 0.1 points per year of aging to simulate normal cognitive aging, independent of the pacemaker.</p></li>
</ul>
<blockquote class="blockquote">
<p><strong>Source:</strong> <em>Nasreddine, Z. S., et al.&nbsp;(2005). The Montreal Cognitive Assessment, MoCA: a brief screening tool for mild cognitive impairment. Journal of the American Geriatrics Society.</em> <a href="https://pubmed.ncbi.nlm.nih.gov/15817019/">Link to Paper</a></p>
</blockquote>
</section>
<section id="esri-socioeconomic-status-index-sei-scale-0-to-100-continuous" class="level3">
<h3 class="anchored" data-anchor-id="esri-socioeconomic-status-index-sei-scale-0-to-100-continuous">4.3 Esri Socioeconomic Status Index (SEI) Scale: 0 to 100 (Continuous)</h3>
<p>We modeled our population using the <strong>Esri 2023/2028 Updated Demographics</strong> methodology. Unlike generic wealth variables, the SEI is a composite measure of income, educational attainment, and employment status—factors proven to be stronger predictors of health outcomes than income alone.</p>
<ul>
<li><p><strong>National Benchmark (Mean):</strong> The US national average SEI score is <strong>47.5</strong>.</p></li>
<li><p>Scores below <strong>45</strong> are classified as <strong>Low SES</strong> and are clinically correlated with higher rates of comorbidity and lower access to specialized medical devices (like MRIs or Pacemakers).</p></li>
<li><p>Scores above <strong>65</strong> indicate High SES correlating with better insurance coverage and earlier intervention.</p></li>
</ul>
<blockquote class="blockquote">
<p><strong>Primary Source:</strong> <em>Esri. (2023). Methodology Statement: 2023/2028 Esri Updated Demographics.</em> <a href="https://doc.arcgis.com/en/esri-demographics/latest/esri-demographics/updated-demographics.htm">Link to PDF Methodology</a></p>
<p><strong>Secondary Source (Health Link):</strong> <em>Battioui, C. (Esri Health). Calculating Health Disparity Indexes.</em> (Demonstrates SEI’s power in predicting disease mortality).</p>
<p>Consistent with <em>JAMA Cardiology (2017)</em> findings on inequity, we modeled our Pacemaker Group to have a higher mean SEI while the Control Group drifts lower</p>
</blockquote>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Covariate</th>
<th>Value</th>
<th>Interpretation</th>
<th>Source/Derivation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Age</td>
<td>-0.1</td>
<td>Loss of 1 point per decade of aging.</td>
<td><em>Nasreddine et al.</em> (Standard Age Decay)</td>
</tr>
<tr class="even">
<td>SEI/SES</td>
<td>+0.05</td>
<td>Gain of 2 points between Low/High SES.</td>
<td>Medical literature says High Education provides about a <strong>2-point</strong> bonus on the MoCA test compared to Low Education. So we did a linear approximiation by defining a Low Esri score as 30 and high as 70. (2/40 = 0.05)</td>
</tr>
<tr class="odd">
<td>Treatment delta</td>
<td>-2.5</td>
<td>Drop from Normal to Mild Cognitive Impairment</td>
<td><em>Clinical Significance Threshold</em> (Change &gt; 2 pts)</td>
</tr>
</tbody>
</table>
</section>
<section id="data-code" class="level3">
<h3 class="anchored" data-anchor-id="data-code">4.4 Data Code</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)   </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2026</span>)   <span class="co">#@team please do not change the seed!</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PART 1: Generate Covariates (N=1000) ---</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># AGE GENERATION:</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We generate a broad pool (Mean 65), but the Treatment Assignment (Part 2) </span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># will filter this so Pacemaker group is ~76 and Control is ~58.</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Constraint: Minimum age 50.</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">65</span>, <span class="at">sd =</span> <span class="dv">15</span>) <span class="sc">%&gt;%</span> <span class="fu">pmax</span>(<span class="dv">50</span>) <span class="sc">%&gt;%</span> <span class="fu">pmin</span>(<span class="dv">95</span>)<span class="sc">%&gt;%</span><span class="fu">round</span>(),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SES GENERATION (Esri SEI Standard):</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mean: 47.5 (National Average)</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SD: 15 (Derived from Esri High/Low cutoffs)</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">esri_sei =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="fl">47.5</span>, <span class="at">sd =</span> <span class="dv">15</span>) <span class="sc">%&gt;%</span> <span class="fu">pmax</span>(<span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">pmin</span>(<span class="dv">100</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PART 2: Assign Treatment (Selection Bias) ---</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># We use a Logistic Probability model to assign pacemakers.</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># - Age Coefficient (0.15): Strong positive. Older people get pacemakers.</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># - SEI Coefficient (0.04): Weak positive. Wealthier people get access.</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># - Intercept (-12): Calibrates the overall rate to be realistic (~30-40%).</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>logit_prob <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">12</span> <span class="sc">+</span> (<span class="fl">0.15</span> <span class="sc">*</span> data<span class="sc">$</span>age) <span class="sc">+</span> (<span class="fl">0.04</span> <span class="sc">*</span> data<span class="sc">$</span>esri_sei)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>prob_treatment <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_prob)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>pacemaker <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="dv">1</span>, prob_treatment)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PART 3: Generate Outcome (MoCA Score) ---</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters based on Nasreddine et al. (2005) &amp; Clinical norms.</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Healthy Baseline: 27.5 (for a 60-year-old)</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Age Decay: -0.1 points per year</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. SES Buffer: +0.05 points per SEI unit (Cognitive Reserve)</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. TRUE TREATMENT EFFECT: -2.5 points (The Diagnostic Delay Penalty)</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>true_treatment_effect <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">2.5</span> </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exogenous Cognitive Health (What they would have without the device)</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">cog_baseline =</span> <span class="fl">27.5</span> <span class="sc">-</span> <span class="fl">0.1</span> <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">60</span>) <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> (esri_sei <span class="sc">-</span> <span class="fl">47.5</span>),</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add Measurement Noise (SD = 2.2)</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">noise =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">2.2</span>),</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Potential Outcomes</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_0 =</span> cog_baseline <span class="sc">+</span> noise,                     <span class="co"># Outcome if Control</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_1 =</span> cog_baseline <span class="sc">+</span> true_treatment_effect <span class="sc">+</span> noise, <span class="co"># Outcome if Treated</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Observed Outcome (The one we actually see in the data)</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">moca_score =</span> <span class="fu">ifelse</span>(pacemaker <span class="sc">==</span> <span class="dv">1</span>, y_1, y_0),</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clinical Bounds: MoCA scale is strictly 0-30</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">moca_score =</span> <span class="fu">pmin</span>(moca_score, <span class="dv">30</span>) <span class="sc">%&gt;%</span> <span class="fu">pmax</span>(<span class="dv">0</span>)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="co"># --- PART 4: Verification Table ---</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="co"># This proves to the client that your data matches the clinical literature.</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="co"># You should see:</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a><span class="co"># - Pacemaker Age ~ 75-76</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="co"># - Control Age ~ 57-59</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="co"># - Pacemaker SEI &gt; Control SEI (Access Gap)</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>verification_table <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pacemaker) <span class="sc">%&gt;%</span> </span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">Count =</span> <span class="fu">n</span>(),</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Age =</span> <span class="fu">round</span>(<span class="fu">mean</span>(age), <span class="dv">1</span>),</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Esri_SEI =</span> <span class="fu">round</span>(<span class="fu">mean</span>(esri_sei), <span class="dv">1</span>),</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_MoCA =</span> <span class="fu">round</span>(<span class="fu">mean</span>(moca_score), <span class="dv">1</span>)</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(verification_table, <span class="at">caption =</span> <span class="st">"Table 1: Baseline Characteristics by Treatment Group"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Table 1: Baseline Characteristics by Treatment Group</caption>
<thead>
<tr class="header">
<th style="text-align: right;">pacemaker</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Avg_Age</th>
<th style="text-align: right;">Avg_Esri_SEI</th>
<th style="text-align: right;">Avg_MoCA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">550</td>
<td style="text-align: right;">59.4</td>
<td style="text-align: right;">44.7</td>
<td style="text-align: right;">27.1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">450</td>
<td style="text-align: right;">74.5</td>
<td style="text-align: right;">50.4</td>
<td style="text-align: right;">23.5</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
     id   age esri_sei pacemaker cog_baseline  noise   y_0   y_1 moca_score
  &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1     1    73     74.1         1         27.5 -2.12   25.4  22.9       22.9
2     2    50     61.0         0         29.2  0.901  30.1  27.6       30  
3     3    67     67.5         1         27.8  1.73   29.5  27.0       27.0
4     4    64     42.3         0         26.8  1.57   28.4  25.9       28.4
5     5    55     63.4         0         28.8 -1.47   27.3  24.8       27.3
6     6    50     38.2         0         28.0 -1.88   26.2  23.7       26.2</code></pre>
</div>
</div>
<div class="line-block"><strong>Note:</strong> Think of <code>y_0</code> and <code>y_1</code> as the answer key. We generated them using ‘God Mode’ (seeing parallel universes) so we know the exact truth of what the pacemaker does. But when we run the actual Matching code, we have to pretend we can’t see them. We only peek at them at the very end to prove our matching worked</div>
<blockquote class="blockquote">
<p><strong>Note on LLM usage:</strong> For building the dataset, we used the following prompts:<br>
We are testing if having a <strong>Pacemaker (D)</strong> causes a drop in <strong>Cognitive Scores (Y)</strong> because patients can’t get MRIs easily.</p>
<p><strong>Data Requirements:</strong></p>
<p>Please write R script to generate 1000 synthetic patients with the following rules:</p>
<ol type="1">
<li><p><strong>Variables &amp; Distributions:</strong></p>
<ul>
<li><p>pacemaker (Treatment): Binary 0/1.</p></li>
<li><p><code>moca_score</code>(Outcome): Scale 0–30.</p></li>
<li><p><code>age</code> (Confounder): Mean 75, SD 7.</p></li>
<li><p><code>ses_index</code> (Confounder): Mean 50, SD 15</p></li>
</ul></li>
<li><p><strong>Selection bias</strong></p>
<ul>
<li><p>You need to build in confounding so I can use Propensity Score Matching later.</p></li>
<li><p><strong>Wealth Bias:</strong> High SES patients should be more likely to get a pacemaker AND naturally have <strong>higher</strong> moCA</p></li>
<li><p><strong>Health Bias:</strong> Older/sicker patients should be more likely to get a pacemaker but naturally have <strong>lower</strong> MoCA</p></li>
</ul></li>
<li><p><strong>The Target Effect:</strong> Hard code a <strong>True Treatment Effect (ATT) of -2.5 points</strong>.</p></li>
</ol>
</blockquote>
</section>
</section>
<section id="eda" class="level2">
<h2 class="anchored" data-anchor-id="eda">5. EDA</h2>
<section id="age-distribution-between-control-and-treated-groups" class="level3">
<h3 class="anchored" data-anchor-id="age-distribution-between-control-and-treated-groups">5.1 Age Distribution between control and treated groups</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Density Plot for Age - Checks for Common Support</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">fill =</span> <span class="fu">factor</span>(pacemaker))) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Age Distribution"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Pacemaker patients are significantly older, creating a confounder."</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age"</span>, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Pacemaker (1=Yes)"</span>) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There is considerable overlap between the groups, meaning the data is conducive for matching.</p>
</section>
<section id="cognitive-decline-between-control-and-treated-groups-as-a-function-of-age" class="level3">
<h3 class="anchored" data-anchor-id="cognitive-decline-between-control-and-treated-groups-as-a-function-of-age">5.2 Cognitive Decline between control and treated groups as a function of age</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter Plot</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> moca_score, <span class="at">color =</span> <span class="fu">factor</span>(pacemaker))) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"MoCA Score Decay by Age"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Notice the gap between the two lines (The Treatment Effect?)"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age"</span>, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"MoCA Score"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Pacemaker"</span>) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot shows clear differences between treated and control groups in terms of their MoCA score. While both groups see cognitive decline with age, the two lines are offset suggesting that there might be a treatment in place.</p>
</section>
<section id="ses-by-treatment-group" class="level3">
<h3 class="anchored" data-anchor-id="ses-by-treatment-group">5.3 SES by Treatment Group</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(pacemaker), <span class="at">y =</span> esri_sei, <span class="at">fill =</span> <span class="fu">factor</span>(pacemaker))) <span class="sc">+</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Socioeconomic Status by Treatment Group"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Pacemaker patients tend to have higher SES"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Treatment Status (0=No Pacemaker, 1=Pacemaker)"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Esri SES Index"</span>) <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Pastel1"</span>) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The Pacemaker group has a higher median Socioeconomic Status (SES) than the control group. Since we know higher SES correlates with better cognition due to better access to healthcare, this imbalance inflates the Pacemaker group’s MoCA scores. If we don’t control for this, the pacemaker might look more beneficial (or less harmful) than it actually is.</p>
</section>
<section id="propensity-score-overlap" class="level3">
<h3 class="anchored" data-anchor-id="propensity-score-overlap">5.4 Propensity score overlap</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate propensity scores just for visualization</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ps_model_viz <span class="ot">&lt;-</span> <span class="fu">glm</span>(pacemaker <span class="sc">~</span> age <span class="sc">+</span> esri_sei, <span class="at">data =</span> data, <span class="at">family =</span> binomial)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ps_viz <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps_model_viz, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> ps_viz, <span class="at">fill =</span> <span class="fu">factor</span>(pacemaker))) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Propensity Score Overlap"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Probability of Receiving Pacemaker (Propensity Score)"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Group"</span>) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"gray"</span>, <span class="st">"blue"</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Treated"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see that while the distributions differ (Treated units have higher probability scores), there is significant overlap in the middle. This confirms that Matching is a good strategy. There are enough control patients with similar characteristics to treated patients to form valid comparisons.</p>
</section>
</section>
<section id="matching" class="level2">
<h2 class="anchored" data-anchor-id="matching">6. Matching</h2>
<section id="k-1-exact-matching" class="level3">
<h3 class="anchored" data-anchor-id="k-1-exact-matching">6.3 k-1 Exact Matching</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"MatchIt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>matches.Exact.Age <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  pacemaker <span class="sc">~</span> age,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"exact"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Exact matching...
Calculating matching weights...Done.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matches.Exact.Age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = pacemaker ~ age, data = data, method = "exact", 
    verbose = TRUE)

Summary of Balance for All Data:
    Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
age       74.4756         59.44          1.3152     1.5632    0.3269   0.5349

Summary of Balance for Matched Data:
    Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
age       70.6236       70.6236              -0     0.9962         0        0
    Std. Pair Dist.
age               0

Sample Sizes:
              Control Treated
All            550.       450
Matched (ESS)  152.68     356
Matched        550.       356
Unmatched        0.        94
Discarded        0.         0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>matches.Exact.Age<span class="ot">&lt;-</span><span class="fu">match.data</span>(matches.Exact.Age) </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(matches.Exact.Age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 12
     id   age esri_sei pacemaker cog_baseline  noise   y_0   y_1 moca_score
  &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1     1    73     74.1         1         27.5 -2.12   25.4  22.9       22.9
2     2    50     61.0         0         29.2  0.901  30.1  27.6       30  
3     3    67     67.5         1         27.8  1.73   29.5  27.0       27.0
4     4    64     42.3         0         26.8  1.57   28.4  25.9       28.4
5     5    55     63.4         0         28.8 -1.47   27.3  24.8       27.3
6     6    50     38.2         0         28.0 -1.88   26.2  23.7       26.2
# ℹ 3 more variables: ps_viz &lt;dbl&gt;, weights &lt;dbl&gt;, subclass &lt;fct&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>AvgTreat<span class="ot">&lt;-</span>matches.Exact.Age <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pacemaker <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(moca_score)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>AvgControl<span class="ot">&lt;-</span>matches.Exact.Age <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pacemaker <span class="sc">==</span> <span class="dv">0</span>)<span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(moca_score)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>TE.Exact.Age.DiM<span class="ot">&lt;-</span><span class="fu">mean</span>(AvgTreat<span class="sc">$</span>moca_score)<span class="sc">-</span><span class="fu">mean</span>(AvgControl<span class="sc">$</span>moca_score)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>TE.Exact.Age.DiM</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -3.171342</code></pre>
</div>
</div>
<p><strong>Technical Explanation:</strong> We are calculating ATE, which is the average treatment effect for the general population, since our focus is to find effects of pacemaker implementation in general, and not specifically in either people with or without pacemakers.</p>
<p>First,our k-1 exact matching has std. mean difference of 0, which means that the average age between treatment and control is zero, which is ideal (our groups are balanced).</p>
<p>Since in reality, there is no duplicate of a person being given the counterfactual treatment, the ATE is calculated as:</p>
<p><span class="math display">\[ \widehat{\text{ATE}} = \mathbb{E}[Y \mid D = 1] - \mathbb{E}[Y \mid D = 0] \]</span></p>
<p>where Y = moca_score and D = pacemaker (1 or 0)</p>
<p>It should be noted that this isn’t exact ATE, but rather an estimate of ATE which is a sum of ATT and selection bias.</p>
<p><strong>Non-Technical Explanation:</strong> In k-1 exact matching, we take one unit of either treated or control groups, and we find all units from the opposite group that look the same. In our case, “looking the same”, means that they have the same age. This ensures they are directly comparable After doing this, we can average the MoCA scores over all treated and all untreated units and calculate the difference, which in our case, is -3.17, which falls in line with the intuition that pacemaker implementation has a negative effect on a persons health.</p>
<p>It should be noted that since we are matching over only one covariate, the matches, while being more in number, are not as accurate.</p>
</section>
<section id="section" class="level3">
<h3 class="anchored" data-anchor-id="section"></h3>
</section>
<section id="coarsened-exact-matching" class="level3">
<h3 class="anchored" data-anchor-id="coarsened-exact-matching">6.2 Coarsened Exact Matching</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"MatchIt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>matches.Exact.Sei.Age <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  pacemaker <span class="sc">~</span> esri_sei<span class="sc">+</span>age,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cem"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coarsened exact matching...
Calculating matching weights...Done.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matches.Exact.Sei.Age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = pacemaker ~ esri_sei + age, data = data, method = "cem", 
    estimand = "ATE", verbose = TRUE)

Summary of Balance for All Data:
         Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
esri_sei       50.3814       44.7012          0.3990     0.9875    0.1085
age            74.4756       59.4400          1.4525     1.5632    0.3269
         eCDF Max
esri_sei   0.1628
age        0.5349

Summary of Balance for Matched Data:
         Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
esri_sei       48.2423       47.9091          0.0234     1.0319    0.0098
age            64.8702       64.5958          0.0265     1.0175    0.0070
         eCDF Max Std. Pair Dist.
esri_sei    0.050          0.1833
age         0.025          0.1318

Sample Sizes:
              Control Treated
All            550.    450.  
Matched (ESS)  291.69  137.91
Matched        483.    350.  
Unmatched       67.    100.  
Discarded        0.      0.  </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>matches.Exact.Sei.Age<span class="ot">&lt;-</span><span class="fu">match.data</span>(matches.Exact.Sei.Age) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(matches.Exact.Sei.Age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 12
     id   age esri_sei pacemaker cog_baseline  noise   y_0   y_1 moca_score
  &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1     2    50     61.0         0         29.2  0.901  30.1  27.6       30  
2     3    67     67.5         1         27.8  1.73   29.5  27.0       27.0
3     4    64     42.3         0         26.8  1.57   28.4  25.9       28.4
4     5    55     63.4         0         28.8 -1.47   27.3  24.8       27.3
5     6    50     38.2         0         28.0 -1.88   26.2  23.7       26.2
6     7    54     57.3         0         28.6 -2.44   26.2  23.7       26.2
# ℹ 3 more variables: ps_viz &lt;dbl&gt;, weights &lt;dbl&gt;, subclass &lt;fct&gt;</code></pre>
</div>
</div>
<p>library(dplyr)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>TE.CEM <span class="ot">&lt;-</span> <span class="fu">with</span>(matches.Exact.Sei.Age,</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">weighted.mean</span>(moca_score[pacemaker <span class="sc">==</span> <span class="dv">1</span>], weights[pacemaker <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">weighted.mean</span>(moca_score[pacemaker <span class="sc">==</span> <span class="dv">0</span>], weights[pacemaker <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>TE.CEM</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2.352742</code></pre>
</div>
</div>
<p><strong>Technical Explanation:</strong> We are calculating ATE, which is the average treatment effect for the general population, since our focus is to find effects of pacemaker implementation in general, and not specifically in either people with or without pacemakers. In coarsened exact matching, the covariates (age and ESRI SEI) are divided into bins before matching. When not specified, the system automatically determines the bins based on the data.</p>
<p>After binning, CEM performs matching on these bins. Coarsened exact matching assigns to each observation based on the size of their bin and the proportion of treated vs.&nbsp;control units in that bin. The standard mean differences are 0.024 and 0.0265 for age and ESRI SEI respectively. While this is not as good as what we got in k-1 exact matching, it is small enough to be acceptable.</p>
<p>Since in reality, there is no duplicate of a person being given the counterfactual treatment, the ATE is calculated as:</p>
<p><span class="math display">\[ \widehat{\text{ATE}} = \frac{\sum_{i: D_i=1} w_i Y_i}{\sum_{i: D_i=1} w_i}  - \frac{\sum_{i: D_i=0} w_i Y_i}{\sum_{i: D_i=0} w_i} \]</span></p>
<p>where Y = moca_score, D = pacemaker (1 or 0), and wi​ are the CEM weights.</p>
<p>These weights ensure that each bin contributes proportionally to the population ATE estimate, accounting for varying bin. It should be noted that this isn’t exact ATE, but rather an estimate of ATE which reduces selection bias through the coarsening and weighting mechanism.</p>
<p><strong>Non-Technical Explanation:</strong> When matching over multiple covariates, finding exact matches can be difficult, and may lead to us discarding many samples. To get around this, instead of matching on exact covariate values, we can divide coavariate values into bins and match on those. After this, we calculate the weighted mean for treatment and control and take the difference to get an ATE estimate, which in our case is -2.357, which falls in line with the intuition that pacemaker implementation has a negative effect on a persons health.</p>
<p>Coarsening may generate more matches (not in our case, likely due to using two covariates).</p>
</section>
<section id="propensity-score-matching" class="level3">
<h3 class="anchored" data-anchor-id="propensity-score-matching">6.3 Propensity Score Matching</h3>
<section id="create-matches" class="level4">
<h4 class="anchored" data-anchor-id="create-matches">Create Matches</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>matches.PS <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  pacemaker <span class="sc">~</span> age <span class="sc">+</span> esri_sei,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> data,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method   =</span> <span class="st">"nearest"</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> <span class="st">"logit"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">ratio    =</span> <span class="dv">1</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="check-balance" class="level4">
<h4 class="anchored" data-anchor-id="check-balance">Check Balance</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(matches.PS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = pacemaker ~ age + esri_sei, data = data, method = "nearest", 
    distance = "logit", estimand = "ATT", ratio = 1)

Summary of Balance for All Data:
         Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance        0.6786        0.2629          1.5921     1.2615    0.3705
age            74.4756       59.4400          1.3152     1.5632    0.3269
esri_sei       50.3814       44.7012          0.4003     0.9875    0.1085
         eCDF Max
distance   0.5905
age        0.5349
esri_sei   0.1628

Summary of Balance for Matched Data:
         Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance        0.6786        0.3131          1.3998     1.3077    0.3077
age            74.4756       61.3400          1.1490     1.6079    0.2856
esri_sei       50.3814       47.5849          0.1971     1.0985    0.0495
         eCDF Max Std. Pair Dist.
distance   0.5511          1.3998
age        0.5022          1.1708
esri_sei   0.0978          1.1135

Sample Sizes:
          Control Treated
All           550     450
Matched       450     450
Unmatched     100       0
Discarded       0       0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(matches.PS, <span class="at">type =</span> <span class="st">"jitter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>To identify the units, use first mouse button; to stop, use second.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>matched.PS <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matches.PS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="treatment-effect-via-dim" class="level4">
<h4 class="anchored" data-anchor-id="treatment-effect-via-dim">Treatment Effect via DiM</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>PS.treated <span class="ot">&lt;-</span> matched.PS <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pacemaker <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(moca_score)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>PS.control <span class="ot">&lt;-</span> matched.PS <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pacemaker <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(moca_score)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>TE.PS.DiM <span class="ot">&lt;-</span> <span class="fu">mean</span>(PS.treated<span class="sc">$</span>moca_score) <span class="sc">-</span> <span class="fu">mean</span>(PS.control<span class="sc">$</span>moca_score)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>TE.PS.DiM</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -3.574429</code></pre>
</div>
</div>
</section>
<section id="treatment-effect-via-g-computation-ate" class="level4">
<h4 class="anchored" data-anchor-id="treatment-effect-via-g-computation-ate">Treatment Effect via G-Computation (ATE)</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>model.PS.ATE <span class="ot">&lt;-</span> <span class="fu">lm</span>(moca_score <span class="sc">~</span> pacemaker <span class="sc">+</span> age <span class="sc">+</span> esri_sei,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> matched.PS, <span class="at">weights =</span> weights)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>TE.PS.ATE <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  model.PS.ATE,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"pacemaker"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> <span class="fu">subset</span>(matched.PS, pacemaker <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov      =</span> <span class="sc">~</span>subclass,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">wts       =</span> <span class="st">"weights"</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>TE.PS.ATE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Estimate Std. Error     z Pr(&gt;|z|)     S 2.5 % 97.5 %
     -2.4      0.177 -13.6   &lt;0.001 137.0 -2.74  -2.05

Term: pacemaker
Type: response
Comparison: 1 - 0</code></pre>
</div>
</div>
</section>
<section id="potential-outcomes-ate" class="level4">
<h4 class="anchored" data-anchor-id="potential-outcomes-ate">Potential Outcomes (ATE)</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>PotOutcomes.PS.ATE <span class="ot">&lt;-</span> <span class="fu">avg_predictions</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  model.PS.ATE,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"pacemaker"</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata   =</span> matched.PS</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>PotOutcomes.PS.ATE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 pacemaker Estimate Std. Error   z Pr(&gt;|z|)   S 2.5 % 97.5 %
         0     26.5       0.11 241   &lt;0.001 Inf  26.3   26.7
         1     24.1       0.11 219   &lt;0.001 Inf  23.9   24.3

Type: response</code></pre>
</div>
</div>
</section>
</section>
<section id="iptw-analysis" class="level3">
<h3 class="anchored" data-anchor-id="iptw-analysis">6.4 IPTW Analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># IPTW ANALYSIS: ATE ESTIMATION</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># PART 6.4: IPTW Analysis</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>data_iptw <span class="ot">&lt;-</span> data </span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Estimate Propensity Scores</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 'pacemaker' is the Treatment (D), 'age' and 'esri_sei' are Confounders (X)</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  pacemaker <span class="sc">~</span> age <span class="sc">+</span> esri_sei,</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_iptw,</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Generate and store Propensity Scores</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>data_iptw<span class="sc">$</span>pscore <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps_model, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Construct IPTW Weights (ATE)</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>data_iptw <span class="ot">&lt;-</span> data_iptw <span class="sc">%&gt;%</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">iptw =</span> <span class="fu">ifelse</span>(</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>      pacemaker <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span> <span class="sc">/</span> pscore,</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> pscore)</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Estimate Treatment Effect using Survey Design</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>iptw_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">ids =</span> <span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_iptw,</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="sc">~</span>iptw</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>iptw_model <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>  moca_score <span class="sc">~</span> pacemaker,</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">design =</span> iptw_design</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Extract ATE Estimate</span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>ate_estimate <span class="ot">&lt;-</span> <span class="fu">tidy</span>(iptw_model) <span class="sc">%&gt;%</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"pacemaker"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(estimate, std.error, statistic, p.value)</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(ate_estimate, <span class="at">caption =</span> <span class="st">"IPTW Estimate of Average Treatment Effect (ATE)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>IPTW Estimate of Average Treatment Effect (ATE)</caption>
<thead>
<tr class="header">
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">-2.528248</td>
<td style="text-align: right;">0.2525754</td>
<td style="text-align: right;">-10.00987</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">#In this study, receiving a pacemaker is not randomized. Instead, the probability of treatment depends on observed characteristics such as age and socioeconomic status. Because these covariates also affect cognitive outcomes (MoCA score), a simple comparison of treated and untreated individuals would produce biased estimates of the treatment effect.</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#To address this problem, we use Inverse Probability of Treatment Weighting (IPTW), a causal inference method based on propensity scores.</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">#IPTW is used to estimate the causal effect of pacemaker treatment on cognitive outcomes by reweighting the data to remove selection bias arising from non-random treatment assignment.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="randomized-control-trial" class="level2">
<h2 class="anchored" data-anchor-id="randomized-control-trial">7. Randomized Control Trial</h2>
<p>Suppose we could randomly assign treatment (i.e.&nbsp;we decide who gets a pacemaker). We will consider four methods of treatment assignment: i) simple, ii) complete, iii) block, iv) cluster.</p>
<p>Because we are now imagining a randomized experiment, we ignore the observational <code>pacemaker</code> variable created earlier and instead randomly assign treatment.</p>
<section id="housekeeping" class="level3">
<h3 class="anchored" data-anchor-id="housekeeping">7.0 Housekeeping</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomizr)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also create helper labels for stratification (used later in block and cluster assignment).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">old =</span> <span class="fu">ifelse</span>(age <span class="sc">&gt;=</span> <span class="fu">median</span>(age), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">AgeLabel =</span> <span class="fu">ifelse</span>(old <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Old"</span>, <span class="st">"Young"</span>),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_sei =</span> <span class="fu">ifelse</span>(esri_sei <span class="sc">&gt;</span> <span class="fu">mean</span>(esri_sei), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEILabel =</span> <span class="fu">ifelse</span>(high_sei <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"High SES"</span>, <span class="st">"Low SES"</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simple-treatment-assignment" class="level3">
<h3 class="anchored" data-anchor-id="simple-treatment-assignment">7.1 Simple Treatment Assignment</h3>
<p>A “simple” assignment flips a fair coin for each individual.</p>
<section id="treatment-assignment" class="level4">
<h4 class="anchored" data-anchor-id="treatment-assignment">Treatment Assignment</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>data.RCT <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treat.simple =</span> <span class="fu">simple_ra</span>(<span class="at">N =</span> <span class="fu">nrow</span>(data))) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TreatLabel =</span> <span class="fu">ifelse</span>(treat.simple <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Treated"</span>, <span class="st">"Untreated"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rct_outcome =</span> <span class="fu">ifelse</span>(treat.simple <span class="sc">==</span> <span class="dv">1</span>, y_1, y_0))</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data.RCT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 17
     id   age esri_sei pacemaker cog_baseline  noise   y_0   y_1 moca_score
  &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1     1    73     74.1         1         27.5 -2.12   25.4  22.9       22.9
2     2    50     61.0         0         29.2  0.901  30.1  27.6       30  
3     3    67     67.5         1         27.8  1.73   29.5  27.0       27.0
4     4    64     42.3         0         26.8  1.57   28.4  25.9       28.4
5     5    55     63.4         0         28.8 -1.47   27.3  24.8       27.3
6     6    50     38.2         0         28.0 -1.88   26.2  23.7       26.2
# ℹ 8 more variables: ps_viz &lt;dbl&gt;, old &lt;dbl&gt;, AgeLabel &lt;chr&gt;, high_sei &lt;dbl&gt;,
#   SEILabel &lt;chr&gt;, treat.simple &lt;int&gt;, TreatLabel &lt;chr&gt;, rct_outcome &lt;dbl&gt;</code></pre>
</div>
</div>
<section id="proportions" class="level5">
<h5 class="anchored" data-anchor-id="proportions">Proportions</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">table</span>(data.RCT<span class="sc">$</span>TreatLabel)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  Treated Untreated 
      493       507 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(tbl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  Treated Untreated 
    0.493     0.507 </code></pre>
</div>
</div>
</section>
</section>
<section id="check-age-balance" class="level4">
<h4 class="anchored" data-anchor-id="check-age-balance">Check Age Balance</h4>
<section id="mosaic-plot" class="level5">
<h5 class="anchored" data-anchor-id="mosaic-plot">Mosaic Plot</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>ContingencyTable <span class="ot">&lt;-</span> <span class="fu">table</span>(data.RCT<span class="sc">$</span>age, data.RCT<span class="sc">$</span>treat.simple)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(ContingencyTable,</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="cn">TRUE</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"Age"</span>,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Simple Random Assignment, Age"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ks-test" class="level5">
<h5 class="anchored" data-anchor-id="ks-test">KS Test</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>treated <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.simple <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>untreated <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.simple <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ks.test</span>(treated<span class="sc">$</span>age, untreated<span class="sc">$</span>age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Asymptotic two-sample Kolmogorov-Smirnov test

data:  treated$age and untreated$age
D = 0.029102, p-value = 0.984
alternative hypothesis: two-sided</code></pre>
</div>
</div>
<p>A large p-value (0.984), implies we fail to reject the null, implying the density of ages among the treated group is the same as those in the untreated group.</p>
</section>
<section id="qq-plot" class="level5">
<h5 class="anchored" data-anchor-id="qq-plot">QQ Plot</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qqplot</span>(treated<span class="sc">$</span>age, untreated<span class="sc">$</span>age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="equal-proportions-oldyoung" class="level5">
<h5 class="anchored" data-anchor-id="equal-proportions-oldyoung">Equal Proportions (Old/Young)</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">table</span>(data.RCT<span class="sc">$</span>TreatLabel, data.RCT<span class="sc">$</span>AgeLabel)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           
            Old Young
  Treated   261   232
  Untreated 258   249</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(tbl, <span class="at">margin =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           
                  Old     Young
  Treated   0.5294118 0.4705882
  Untreated 0.5088757 0.4911243</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.test</span>(tbl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    2-sample test for equality of proportions with continuity correction

data:  tbl
X-squared = 0.344, df = 1, p-value = 0.5575
alternative hypothesis: two.sided
95 percent confidence interval:
 -0.04339073  0.08446278
sample estimates:
   prop 1    prop 2 
0.5294118 0.5088757 </code></pre>
</div>
</div>
</section>
</section>
<section id="check-ses-balance" class="level4">
<h4 class="anchored" data-anchor-id="check-ses-balance">Check SES Balance</h4>
<section id="mosaic-plot-1" class="level5">
<h5 class="anchored" data-anchor-id="mosaic-plot-1">Mosaic Plot</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>ContingencyTable <span class="ot">&lt;-</span> <span class="fu">table</span>(data.RCT<span class="sc">$</span>SEILabel, data.RCT<span class="sc">$</span>treat.simple)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(ContingencyTable,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="cn">TRUE</span>,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"SES"</span>,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Simple Random Assignment, SES"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ks-test-1" class="level5">
<h5 class="anchored" data-anchor-id="ks-test-1">KS Test</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ks.test</span>(treated<span class="sc">$</span>esri_sei, untreated<span class="sc">$</span>esri_sei)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Asymptotic two-sample Kolmogorov-Smirnov test

data:  treated$esri_sei and untreated$esri_sei
D = 0.055219, p-value = 0.4311
alternative hypothesis: two-sided</code></pre>
</div>
</div>
</section>
</section>
<section id="estimate-te" class="level4">
<h4 class="anchored" data-anchor-id="estimate-te">Estimate TE</h4>
<section id="difference-in-means" class="level5">
<h5 class="anchored" data-anchor-id="difference-in-means">Difference in Means</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>simple.treated <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.simple <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>simple.control <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.simple <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>TE.DiM <span class="ot">&lt;-</span> <span class="fu">mean</span>(simple.treated<span class="sc">$</span>rct_outcome) <span class="sc">-</span> <span class="fu">mean</span>(simple.control<span class="sc">$</span>rct_outcome)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>TE.DiM</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2.522731</code></pre>
</div>
</div>
</section>
<section id="t-test" class="level5">
<h5 class="anchored" data-anchor-id="t-test">T-Test</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(simple.control<span class="sc">$</span>rct_outcome, simple.treated<span class="sc">$</span>rct_outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  simple.control$rct_outcome and simple.treated$rct_outcome
t = 14.955, df = 995.44, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 2.191714 2.853747
sample estimates:
mean of x mean of y 
 26.72201  24.19928 </code></pre>
</div>
</div>
<p>Since the p-value (0.749) is well above 0.05, we fail to reject the null hypothesis, meaning there is no statistically<br>
significant difference in MoCA scores between the randomly assigned treated and control groups.</p>
</section>
<section id="ols-regression" class="level5">
<h5 class="anchored" data-anchor-id="ols-regression">OLS Regression</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>TE.OLS <span class="ot">&lt;-</span> <span class="fu">lm</span>(rct_outcome <span class="sc">~</span> treat.simple, <span class="at">data =</span> data.RCT)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(TE.OLS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = rct_outcome ~ treat.simple, data = data.RCT)

Residuals:
    Min      1Q  Median      3Q     Max 
-7.6317 -1.8199  0.0084  1.8329  8.1939 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   26.7220     0.1184  225.69   &lt;2e-16 ***
treat.simple  -2.5227     0.1686  -14.96   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.666 on 998 degrees of freedom
Multiple R-squared:  0.1832,    Adjusted R-squared:  0.1824 
F-statistic: 223.8 on 1 and 998 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
</section>
<section id="ate-att-atc-via-regression" class="level5">
<h5 class="anchored" data-anchor-id="ate-att-atc-via-regression">ATE / ATT / ATC via Regression</h5>
<p>ATE via difference in means</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(rct_outcome <span class="sc">~</span> treat.simple <span class="sc">*</span> (age <span class="sc">+</span> esri_sei), <span class="at">data =</span> data.RCT)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>data.RCT<span class="sc">$</span>Pred.Treated <span class="ot">&lt;-</span> <span class="fu">predict</span>(model,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">treat.simple =</span> <span class="dv">1</span>, dplyr<span class="sc">::</span><span class="fu">select</span>(data.RCT, <span class="sc">!</span>treat.simple)))</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>data.RCT<span class="sc">$</span>Pred.UnTreated <span class="ot">&lt;-</span> <span class="fu">predict</span>(model,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">treat.simple =</span> <span class="dv">0</span>, dplyr<span class="sc">::</span><span class="fu">select</span>(data.RCT, <span class="sc">!</span>treat.simple)))</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>ATE <span class="ot">&lt;-</span> <span class="fu">mean</span>(data.RCT<span class="sc">$</span>Pred.Treated) <span class="sc">-</span> <span class="fu">mean</span>(data.RCT<span class="sc">$</span>Pred.UnTreated)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>ATE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2.493834</code></pre>
</div>
</div>
<p>TE via avg_comparisons</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">avg_comparisons</span>(model, <span class="at">variables =</span> <span class="st">"treat.simple"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Estimate Std. Error     z Pr(&gt;|z|)     S 2.5 % 97.5 %
    -2.49       0.14 -17.8   &lt;0.001 232.7 -2.77  -2.22

Term: treat.simple
Type: response
Comparison: 1 - 0</code></pre>
</div>
</div>
<p>ATT via difference in means</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>ATT <span class="ot">&lt;-</span> <span class="fu">mean</span>(data.RCT[data.RCT<span class="sc">$</span>treat.simple <span class="sc">==</span> <span class="dv">1</span>, ]<span class="sc">$</span>Pred.Treated) <span class="sc">-</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">mean</span>(data.RCT[data.RCT<span class="sc">$</span>treat.simple <span class="sc">==</span> <span class="dv">1</span>, ]<span class="sc">$</span>Pred.UnTreated)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>ATT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2.486319</code></pre>
</div>
</div>
<p>Recomuting via avg_comparisons</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">avg_comparisons</span>(model, <span class="at">variables =</span> <span class="st">"treat.simple"</span>, <span class="fu">subset</span>(data.RCT, treat.simple <span class="sc">==</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Estimate Std. Error     z Pr(&gt;|z|)     S 2.5 % 97.5 %
    -2.49       0.14 -17.7   &lt;0.001 231.1 -2.76  -2.21

Term: treat.simple
Type: response
Comparison: 1 - 0</code></pre>
</div>
</div>
<p>ATC via DiM</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>ATC <span class="ot">&lt;-</span> <span class="fu">mean</span>(data.RCT[data.RCT<span class="sc">$</span>treat.simple <span class="sc">==</span> <span class="dv">0</span>, ]<span class="sc">$</span>Pred.Treated) <span class="sc">-</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">mean</span>(data.RCT[data.RCT<span class="sc">$</span>treat.simple <span class="sc">==</span> <span class="dv">0</span>, ]<span class="sc">$</span>Pred.UnTreated)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>ATC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2.501142</code></pre>
</div>
</div>
<p>Recomuting via avg_comparisons</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">avg_comparisons</span>(model, <span class="at">variables =</span> <span class="st">"treat.simple"</span>, <span class="fu">subset</span>(data.RCT, treat.simple <span class="sc">==</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Estimate Std. Error     z Pr(&gt;|z|)     S 2.5 % 97.5 %
     -2.5       0.14 -17.8   &lt;0.001 233.8 -2.78  -2.23

Term: treat.simple
Type: response
Comparison: 1 - 0</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="complete-treatment-assignment" class="level3">
<h3 class="anchored" data-anchor-id="complete-treatment-assignment">7.2 Complete Treatment Assignment</h3>
<p>With complete assignment we fix the number of treated/control units in advance.</p>
<section id="decide-of-treatcontrol" class="level4">
<h4 class="anchored" data-anchor-id="decide-of-treatcontrol">Decide # of Treat/Control</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>m_each <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">nrow</span>(data.RCT) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">-</span> <span class="dv">50</span>, <span class="fu">nrow</span>(data.RCT) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="complete-random-assignment" class="level4">
<h4 class="anchored" data-anchor-id="complete-random-assignment">Complete Random Assignment</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>data.RCT <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treat.complete =</span> <span class="fu">complete_ra</span>(<span class="at">N =</span> <span class="fu">nrow</span>(data.RCT), <span class="at">m_each =</span> m_each)) <span class="sc">%&gt;%</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rct_outcome_complete =</span> <span class="fu">ifelse</span>(treat.complete <span class="sc">==</span> <span class="dv">1</span>, y_1, y_0))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> <span class="fu">table</span>(data.RCT<span class="sc">$</span>treat.complete)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>tbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
450 550 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(tbl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1 
0.45 0.55 </code></pre>
</div>
</div>
</section>
<section id="check-age-balance-1" class="level4">
<h4 class="anchored" data-anchor-id="check-age-balance-1">Check Age Balance</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>ContingencyTable <span class="ot">&lt;-</span> <span class="fu">table</span>(data.RCT<span class="sc">$</span>age, data.RCT<span class="sc">$</span>treat.complete)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(ContingencyTable,</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="cn">TRUE</span>,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"Age"</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Complete Random Assignment, Age"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="compute-te" class="level4">
<h4 class="anchored" data-anchor-id="compute-te">Compute TE</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>complete.treated <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.complete <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>complete.control <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.complete <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>TE.complete <span class="ot">&lt;-</span> <span class="fu">mean</span>(complete.treated<span class="sc">$</span>rct_outcome_complete) <span class="sc">-</span> <span class="fu">mean</span>(complete.control<span class="sc">$</span>rct_outcome_complete)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>TE.complete</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2.626814</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(complete.control<span class="sc">$</span>rct_outcome_complete, complete.treated<span class="sc">$</span>rct_outcome_complete)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  complete.control$rct_outcome_complete and complete.treated$rct_outcome_complete
t = 15.481, df = 953.31, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 2.293828 2.959800
sample estimates:
mean of x mean of y 
 26.78055  24.15374 </code></pre>
</div>
</div>
<p>The p-value (0.679) is well above 0.05, so we fail to reject the null hypothesis, meaning there is no statistically significant difference in MoCA scores between the complete randomly assigned treated and control groups.</p>
</section>
</section>
<section id="block-treatment-assignment" class="level3">
<h3 class="anchored" data-anchor-id="block-treatment-assignment">7.3 Block Treatment Assignment</h3>
<p>Subjects are sorted into blocks by pre-treatment covariates, then complete random assignment is conducted within each block.</p>
<section id="blocking-by-age" class="level4">
<h4 class="anchored" data-anchor-id="blocking-by-age">Blocking by Age</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>data.RCT <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treat.block =</span> <span class="fu">block_ra</span>(<span class="at">blocks =</span> data.RCT<span class="sc">$</span>age)) <span class="sc">%&gt;%</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rct_outcome_block =</span> <span class="fu">ifelse</span>(treat.block <span class="sc">==</span> <span class="dv">1</span>, y_1, y_0))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data.RCT<span class="sc">$</span>treat.block) <span class="sc">/</span> <span class="fu">nrow</span>(data.RCT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1 
0.497 0.503 </code></pre>
</div>
</div>
</section>
<section id="check-age-balance-2" class="level4">
<h4 class="anchored" data-anchor-id="check-age-balance-2">Check Age Balance</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>ContingencyTable <span class="ot">&lt;-</span> <span class="fu">table</span>(data.RCT<span class="sc">$</span>age, data.RCT<span class="sc">$</span>treat.block)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(ContingencyTable,</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="cn">TRUE</span>,</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"Age"</span>,</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Block Random Assignment by Age, Age"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="check-ses-balance-1" class="level4">
<h4 class="anchored" data-anchor-id="check-ses-balance-1">Check SES Balance</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>ContingencyTable <span class="ot">&lt;-</span> <span class="fu">table</span>(data.RCT<span class="sc">$</span>SEILabel, data.RCT<span class="sc">$</span>treat.block)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mosaicplot</span>(ContingencyTable,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="cn">TRUE</span>,</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlab =</span> <span class="st">"SES"</span>,</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylab =</span> <span class="st">"Treatment Status"</span>,</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Block Random Assignment by Age, SES"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="compute-te-1" class="level4">
<h4 class="anchored" data-anchor-id="compute-te-1">Compute TE</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>block.treated <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.block <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>block.control <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.block <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>TE.block <span class="ot">&lt;-</span> <span class="fu">mean</span>(block.treated<span class="sc">$</span>rct_outcome_block) <span class="sc">-</span> <span class="fu">mean</span>(block.control<span class="sc">$</span>rct_outcome_block)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>TE.block</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -2.482713</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(block.control<span class="sc">$</span>rct_outcome_block, block.treated<span class="sc">$</span>rct_outcome_block)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  block.control$rct_outcome_block and block.treated$rct_outcome_block
t = 14.73, df = 994.54, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 2.151968 2.813459
sample estimates:
mean of x mean of y 
 26.70211  24.21940 </code></pre>
</div>
</div>
<p>The p-value (0.7609) is well above 0.05, so we fail to reject the null hypothesis, meaning there is no statistically significant difference in MoCA scores between the complete randomly assigned treated and control groups.</p>
</section>
</section>
<section id="cluster-treatment-assignment" class="level3">
<h3 class="anchored" data-anchor-id="cluster-treatment-assignment">7.4 Cluster Treatment Assignment</h3>
<p>Treatment is assigned at the cluster level. Here we form clusters from the cross of Age (Old/Young) and SES (High/Low).</p>
<section id="form-the-clusters" class="level4">
<h4 class="anchored" data-anchor-id="form-the-clusters">Form the Clusters</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>data.RCT<span class="sc">$</span>clusters <span class="ot">&lt;-</span> <span class="fu">with</span>(data.RCT, <span class="fu">paste</span>(AgeLabel, SEILabel, <span class="at">sep =</span> <span class="st">"_"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(AgeLabel, SEILabel, clusters)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  AgeLabel SEILabel clusters      
  &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;         
1 Old      High SES Old_High SES  
2 Young    High SES Young_High SES
3 Old      High SES Old_High SES  
4 Young    Low SES  Young_Low SES 
5 Young    High SES Young_High SES
6 Young    Low SES  Young_Low SES </code></pre>
</div>
</div>
</section>
<section id="cluster-assignment" class="level4">
<h4 class="anchored" data-anchor-id="cluster-assignment">Cluster Assignment</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>data.RCT <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treat.cluster =</span> <span class="fu">cluster_ra</span>(<span class="at">clusters =</span> clusters)) <span class="sc">%&gt;%</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rct_outcome_cluster =</span> <span class="fu">ifelse</span>(treat.cluster <span class="sc">==</span> <span class="dv">1</span>, y_1, y_0))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(data.RCT<span class="sc">$</span>clusters, data.RCT<span class="sc">$</span>treat.cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                
                   0   1
  Old_High SES   251   0
  Old_Low SES      0 268
  Young_High SES 251   0
  Young_Low SES    0 230</code></pre>
</div>
</div>
</section>
<section id="compute-te-2" class="level4">
<h4 class="anchored" data-anchor-id="compute-te-2">Compute TE</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>cluster.treated <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.cluster <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>cluster.control <span class="ot">&lt;-</span> data.RCT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(treat.cluster <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>TE.cluster <span class="ot">&lt;-</span> <span class="fu">mean</span>(cluster.treated<span class="sc">$</span>rct_outcome_cluster) <span class="sc">-</span> <span class="fu">mean</span>(cluster.control<span class="sc">$</span>rct_outcome_cluster)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>TE.cluster</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -3.669258</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(cluster.control<span class="sc">$</span>rct_outcome_cluster, cluster.treated<span class="sc">$</span>rct_outcome_cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  cluster.control$rct_outcome_cluster and cluster.treated$rct_outcome_cluster
t = 22.304, df = 997.56, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 3.346428 3.992088
sample estimates:
mean of x mean of y 
 27.29309  23.62384 </code></pre>
</div>
</div>
<p>The p-value (6.79e-05) is well below 0.05, so we reject the null hypothesis — there is a statistically significant difference in MoCA scores between the cluster-assigned treated and control groups.</p>
<p>However, this doesn’t mean the cluster RCT “found” the true treatment effect. The issue is that clustering by Age × SES<br>
assigns entire groups together, so the treatment/control groups end up imbalanced on the very covariates (age, SES) that<br>
drive MoCA scores. The estimated difference (~0.76) is picking up confounding from those covariates, not a real treatment<br>
effect. This is why cluster assignment is the least desirable RCT method when avoidable — it’s the most vulnerable to<br>
covariate imbalance.</p>
</section>
</section>
<section id="summary-of-rct-estimates" class="level3">
<h3 class="anchored" data-anchor-id="summary-of-rct-estimates">7.5 Summary of RCT Estimates</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>rct_summary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Simple"</span>, <span class="st">"Complete"</span>, <span class="st">"Block (Age)"</span>, <span class="st">"Cluster (Age x SES)"</span>, <span class="st">"True Effect"</span>),</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">TE_Estimate =</span> <span class="fu">c</span>(TE.DiM, TE.complete, TE.block, TE.cluster, true_treatment_effect)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(rct_summary, <span class="at">caption =</span> <span class="st">"Treatment Effect Estimates Across RCT Methods"</span>, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Treatment Effect Estimates Across RCT Methods</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Method</th>
<th style="text-align: right;">TE_Estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Simple</td>
<td style="text-align: right;">-2.523</td>
</tr>
<tr class="even">
<td style="text-align: left;">Complete</td>
<td style="text-align: right;">-2.627</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Block (Age)</td>
<td style="text-align: right;">-2.483</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cluster (Age x SES)</td>
<td style="text-align: right;">-3.669</td>
</tr>
<tr class="odd">
<td style="text-align: left;">True Effect</td>
<td style="text-align: right;">-2.500</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="selection-bias-method-comparison" class="level2">
<h2 class="anchored" data-anchor-id="selection-bias-method-comparison">8. Selection Bias &amp; Method Comparison</h2>
<section id="naive-difference-in-means" class="level3">
<h3 class="anchored" data-anchor-id="naive-difference-in-means">8.1 Naive Difference in Means</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>TE.Naive <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>moca_score[data<span class="sc">$</span>pacemaker <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">mean</span>(data<span class="sc">$</span>moca_score[data<span class="sc">$</span>pacemaker <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>TE.Naive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -3.64166</code></pre>
</div>
</div>
</section>
<section id="selection-bias-across-methods" class="level3">
<h3 class="anchored" data-anchor-id="selection-bias-across-methods">8.2 Selection Bias Across Methods</h3>
<p><span class="math display">\[\text{Selection Bias} = \text{Estimated TE} - \text{True TE}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>methods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Naive DiM"</span>,</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Exact Match (Age)"</span>,</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">"CEM (Age + SES)"</span>,</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"PS Matching (DiM)"</span>,</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">"PS Matching (G-Comp ATT)"</span>,</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">"IPTW (ATE)"</span>)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>estimates <span class="ot">&lt;-</span> <span class="fu">c</span>(TE.Naive,</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>               TE.Exact.Age.DiM,</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>               TE.CEM,</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>               TE.PS.DiM,</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>               TE.PS.ATE<span class="sc">$</span>estimate,</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>               ate_estimate<span class="sc">$</span>estimate)</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>bias_table <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method   =</span> methods,</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Estimate =</span> <span class="fu">round</span>(estimates, <span class="dv">3</span>),</span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">True_TE  =</span> true_treatment_effect,</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">Bias     =</span> <span class="fu">round</span>(estimates <span class="sc">-</span> true_treatment_effect, <span class="dv">3</span>)</span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(bias_table, <span class="at">caption =</span> <span class="st">"Selection Bias by Estimation Method"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Selection Bias by Estimation Method</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Method</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">True_TE</th>
<th style="text-align: right;">Bias</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Naive DiM</td>
<td style="text-align: right;">-3.642</td>
<td style="text-align: right;">-2.5</td>
<td style="text-align: right;">-1.142</td>
</tr>
<tr class="even">
<td style="text-align: left;">Exact Match (Age)</td>
<td style="text-align: right;">-3.171</td>
<td style="text-align: right;">-2.5</td>
<td style="text-align: right;">-0.671</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CEM (Age + SES)</td>
<td style="text-align: right;">-2.353</td>
<td style="text-align: right;">-2.5</td>
<td style="text-align: right;">0.147</td>
</tr>
<tr class="even">
<td style="text-align: left;">PS Matching (DiM)</td>
<td style="text-align: right;">-3.574</td>
<td style="text-align: right;">-2.5</td>
<td style="text-align: right;">-1.074</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PS Matching (G-Comp ATT)</td>
<td style="text-align: right;">-2.398</td>
<td style="text-align: right;">-2.5</td>
<td style="text-align: right;">0.102</td>
</tr>
<tr class="even">
<td style="text-align: left;">IPTW (ATE)</td>
<td style="text-align: right;">-2.528</td>
<td style="text-align: right;">-2.5</td>
<td style="text-align: right;">-0.028</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="residual-plot-estimated-effect-vs-true-effect" class="level3">
<h3 class="anchored" data-anchor-id="residual-plot-estimated-effect-vs-true-effect">8.3 Residual Plot: Estimated Effect vs True Effect</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bias_table, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Method, Bias), <span class="at">y =</span> Bias)) <span class="sc">+</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title    =</span> <span class="st">"Deviation of Estimated TE from True Effect (-2.5)"</span>,</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Bars closer to zero indicate less selection bias"</span>,</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Estimated TE - True TE (Bias)"</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project1_fixed_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>